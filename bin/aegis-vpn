#!/usr/bin/env bash
#===========================================================
# Aegis-VPN CLI v3.0.0
# Author: Rabindra
# Description: Single entrypoint with menu-driven interface,
#              client management, monitoring, and new v3.0
#              features: status, rotate, backup, restore, check.
#===========================================================

set -euo pipefail

# shellcheck source=../scripts/lib.sh
source "$(dirname "${BASH_SOURCE[0]}")/../scripts/lib.sh"
# shellcheck source=../scripts/log_hooks.sh
source "$(dirname "${BASH_SOURCE[0]}")/../scripts/log_hooks.sh"

# ── Dependency check ──────────────────────────────────────
check_deps() {
    local -a missing=()
    for cmd in wg qrencode curl figlet awk numfmt; do
        command -v "$cmd" &>/dev/null || missing+=("$cmd")
    done
    if (( ${#missing[@]} > 0 )); then
        print_warn "Installing missing dependencies: ${missing[*]}"
        apt-get update -qq
        apt-get install -y wireguard qrencode curl figlet coreutils
    fi
}

# ── Privacy masking (IPv4 + IPv6) ────────────────────────
mask_ip() {
    sed -E \
        's/([0-9]{1,3}\.){3}[0-9]{1,3}/***.***.***.***/g;
         s/([0-9a-fA-F]{0,4}:){2,7}[0-9a-fA-F]{0,4}/****:****:****:****/g'
}

# ── Logs command ──────────────────────────────────────────
logs_cmd() {
    local file="$CONNECTION_LOG"
    local privacy=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --errors)  file="$ERROR_LOG" ;;
            --audit)   file="$AUDIT_LOG" ;;
            --privacy) privacy=true ;;
            *) print_err "Unknown flag: $1"; exit 1 ;;
        esac
        shift
    done

    if [[ ! -f "$file" ]]; then
        print_warn "No logs available at ${file}"
        return
    fi

    if $privacy; then
        tail -f "$file" | mask_ip
    else
        tail -f "$file"
    fi
}

# ── Status command ────────────────────────────────────────
status_cmd() {
    echo -e "${BOLD}Aegis-VPN v${AEGIS_VERSION} — Status${RESET}"
    echo "──────────────────────────────────────────────────"

    if systemctl is-active --quiet "wg-quick@${WG_INTERFACE}"; then
        echo -e "  WireGuard : ${GREEN}running${RESET}"
    else
        echo -e "  WireGuard : ${RED}stopped${RESET}"
        echo ""
        return
    fi

    local start_ts
    start_ts=$(systemctl show "wg-quick@${WG_INTERFACE}" \
               --property=ActiveEnterTimestamp --value 2>/dev/null || echo "unknown")
    echo "  Up since  : ${start_ts}"

    local peer_count=0
    peer_count=$(wg show "$WG_INTERFACE" peers 2>/dev/null | wc -l || echo 0)
    echo "  Peers     : ${peer_count}"
    echo ""

    if (( peer_count > 0 )); then
        printf "  %-20s %-14s %-14s\n" "Client" "Sent" "Received"
        printf "  %s\n" "$(printf '─%.0s' {1..52})"

        while IFS=$'\t ' read -r pubkey tx rx; do
            local cname="unknown"
            for conf in "${CLIENTS_DIR}"/*.conf; do
                [[ -f "$conf" ]] || continue
                local pk
                pk=$(awk '/^PrivateKey[[:space:]]*=/{print $3}' "$conf" \
                     | wg pubkey 2>/dev/null || true)
                if [[ "$pk" == "$pubkey" ]]; then
                    cname=$(basename "$conf" .conf)
                    break
                fi
            done
            local tx_h rx_h
            tx_h=$(numfmt --to=iec "${tx:-0}" 2>/dev/null || echo "${tx:-0}")
            rx_h=$(numfmt --to=iec "${rx:-0}" 2>/dev/null || echo "${rx:-0}")
            printf "  %-20s %-14s %-14s\n" "$cname" "$tx_h" "$rx_h"
        done < <(wg show "$WG_INTERFACE" transfer 2>/dev/null)
    fi
    echo ""
}

# ── Dashboard command ─────────────────────────────────────
dashboard_cmd() {
    local privacy=false
    if [[ "${1:-}" == "--privacy" ]]; then
        privacy=true
    fi

    while true; do
        clear
        if command -v figlet &>/dev/null; then
            figlet -c "Aegis-VPN"
        else
            echo -e "${BOLD}┌───────── Aegis-VPN v${AEGIS_VERSION} Dashboard ─────────┐${RESET}"
        fi

        local peer_count=0
        systemctl is-active --quiet "wg-quick@${WG_INTERFACE}" 2>/dev/null && \
            peer_count=$(wg show "$WG_INTERFACE" peers 2>/dev/null | wc -l) || true

        echo "  Time   : $(date '+%Y-%m-%d %H:%M:%S')"
        echo "  Peers  : ${peer_count}"
        echo "──────────────────────────────────────────────────────────────────────────────"
        printf "%-18s %-14s %-10s %-20s %-8s %-8s\n" \
               "Name" "IPv4" "Status" "Last Handshake" "Sent" "Recv"
        echo "──────────────────────────────────────────────────────────────────────────────"

        if systemctl is-active --quiet "wg-quick@${WG_INTERFACE}" 2>/dev/null; then
            for conf in "${CLIENTS_DIR}"/*.conf; do
                [[ -f "$conf" ]] || continue
                local name ipv4 privkey pubkey
                name=$(basename "$conf" .conf)
                ipv4=$(awk -F'[[:space:]/,]+' '/^Address[[:space:]]*=/{print $3}' "$conf")
                [[ "$privacy" == true ]] && ipv4="***.***.***.***"

                privkey=$(awk '/^PrivateKey[[:space:]]*=/{print $3}' "$conf")
                pubkey=$(echo "$privkey" | wg pubkey 2>/dev/null || true)
                [[ -z "$pubkey" ]] && continue

                local hs_epoch tx rx
                hs_epoch=$(wg show "$WG_INTERFACE" latest-handshakes 2>/dev/null \
                           | awk -v pk="$pubkey" '$1==pk{print $2}')
                tx=$(wg show "$WG_INTERFACE" transfer 2>/dev/null \
                     | awk -v pk="$pubkey" '$1==pk{print $2}')
                rx=$(wg show "$WG_INTERFACE" transfer 2>/dev/null \
                     | awk -v pk="$pubkey" '$1==pk{print $3}')

                local status_str hs_str now delta
                now=$(date +%s)
                if [[ -n "$hs_epoch" && "$hs_epoch" != "0" ]]; then
                    delta=$(( now - hs_epoch ))
                    hs_str=$(date -d "@${hs_epoch}" '+%Y-%m-%d %H:%M:%S' 2>/dev/null || echo "unknown")
                    if (( delta < 180 )); then
                        status_str="${GREEN}online${RESET} "
                    else
                        status_str="${RED}offline${RESET}"
                    fi
                else
                    hs_str="never"
                    status_str="${YELLOW}never${RESET}  "
                fi

                local tx_h rx_h
                tx_h=$(numfmt --to=iec "${tx:-0}" 2>/dev/null || echo "${tx:-0}")
                rx_h=$(numfmt --to=iec "${rx:-0}" 2>/dev/null || echo "${rx:-0}")

                printf "%-18s %-14s " "$name" "$ipv4"
                printf "${status_str} "
                printf "%-20s %-8s %-8s\n" "$hs_str" "$tx_h" "$rx_h"
            done
        else
            echo "  WireGuard is not running."
        fi

        echo "──────────────────────────────────────────────────────────────────────────────"
        echo "  Refreshing every 5s — Ctrl+C to exit"
        sleep 5
    done
}

# ── Client management commands ────────────────────────────
add_client_cmd() {
    "$SCRIPTS_DIR/manage_clients.sh" add
    echo
    read -rp "[*] Press Enter to continue..."
}

remove_client_cmd() {
    "$SCRIPTS_DIR/manage_clients.sh" remove
    echo
    read -rp "[*] Press Enter to continue..."
}

list_client_cmd() {
    "$SCRIPTS_DIR/manage_clients.sh" list
    echo
    read -rp "[*] Press Enter to continue..."
}

# ── Setup command ─────────────────────────────────────────
setup_cmd() {
    check_deps
    mkdir -p "$CLIENTS_DIR" "$LOG_DIR" "$VAR_DIR"
    chmod 700 "$CLIENTS_DIR" "$LOG_DIR"
    print_ok "Setup complete! Directories ready."
    print_info "Run 'sudo ./setup.sh' to install and configure WireGuard."
}

# ── Rotate client keys ────────────────────────────────────
rotate_cmd() {
    local client="${1:-}"
    if [[ -z "$client" ]]; then
        read -rp "Enter client name to rotate keys: " client
    fi
    [[ -z "$client" ]] && { print_err "Client name cannot be empty."; return 1; }
    "$SCRIPTS_DIR/rotate_client.sh" "$client"
    echo
    read -rp "[*] Press Enter to continue..."
}

# ── Rotate server key ─────────────────────────────────────
rotate_server_cmd() {
    local flags=()
    # Pass through --qr if called non-interactively with it
    for arg in "$@"; do flags+=("$arg"); done
    "$SCRIPTS_DIR/rotate_server.sh" "${flags[@]}"
    echo
    read -rp "[*] Press Enter to continue..."
}

# ── Backup command ────────────────────────────────────────
backup_cmd() {
    # shellcheck source=../scripts/backup_restore.sh
    source "$SCRIPTS_DIR/backup_restore.sh"
    do_backup
    echo
    read -rp "[*] Press Enter to continue..."
}

# ── Restore command ───────────────────────────────────────
restore_cmd() {
    local file="${1:-}"
    if [[ -z "$file" ]]; then
        print_err "Usage: aegis-vpn restore <backup-file>"
        exit 1
    fi
    # shellcheck source=../scripts/backup_restore.sh
    source "$SCRIPTS_DIR/backup_restore.sh"
    do_restore "$file"
}

# ── Check command ─────────────────────────────────────────
check_cmd() {
    # shellcheck source=../scripts/validate.sh
    source "$SCRIPTS_DIR/validate.sh"
    validate_config
    echo
    read -rp "[*] Press Enter to continue..."
}

# ── Interactive menu ──────────────────────────────────────
menu() {
    while true; do
        clear
        local peer_count=0
        systemctl is-active --quiet "wg-quick@${WG_INTERFACE}" 2>/dev/null && \
            peer_count=$(wg show "$WG_INTERFACE" peers 2>/dev/null | wc -l) || true

        echo -e "${BOLD}┌──────────────── Aegis-VPN v${AEGIS_VERSION} ────────────────┐${RESET}"
        printf  "│  Active peers : %-29s  │\n" "${peer_count}"
        echo    "│                                                  │"
        echo    "│   1) Setup          7) Status                   │"
        echo    "│   2) Add Client     8) Rotate Client Keys       │"
        echo    "│   3) Remove Client  9) Rotate Server Key        │"
        echo    "│   4) List Clients  10) Backup                   │"
        echo    "│   5) View Logs     11) Restore                  │"
        echo    "│   6) Dashboard     12) Check Config             │"
        echo    "│                   13) Exit                      │"
        echo -e "${BOLD}└──────────────────────────────────────────────────┘${RESET}"
        read -rp "Select an option [1-13]: " choice

        case "$choice" in
            1)  setup_cmd ;;
            2)  add_client_cmd ;;
            3)  remove_client_cmd ;;
            4)  list_client_cmd ;;
            5)  logs_cmd ;;
            6)  dashboard_cmd ;;
            7)  status_cmd; read -rp "[*] Press Enter to continue..." ;;
            8)  rotate_cmd ;;
            9)  rotate_server_cmd ;;
            10) backup_cmd ;;
            11) read -rp "Enter backup file path: " bfile
                restore_cmd "$bfile" ;;
            12) check_cmd ;;
            13) exit 0 ;;
            *)  print_warn "Invalid choice."; sleep 1 ;;
        esac
    done
}

# ── Main CLI parser ───────────────────────────────────────
main() {
    if [[ $# -eq 0 ]]; then
        menu
        exit 0
    fi

    case "$1" in
        setup)     setup_cmd ;;
        add)       shift; add_client_cmd ;;
        remove)    shift; remove_client_cmd ;;
        list)      shift; list_client_cmd ;;
        logs)      shift; logs_cmd "$@" ;;
        dashboard) shift; dashboard_cmd "${1:-}" ;;
        status)    status_cmd ;;
        rotate)        shift; rotate_cmd "${1:-}" ;;
        rotate-server) shift; rotate_server_cmd "$@" ;;
        backup)        backup_cmd ;;
        restore)       shift; restore_cmd "${1:-}" ;;
        check)         source "$SCRIPTS_DIR/validate.sh"; validate_config ;;
        version)       echo "Aegis-VPN v${AEGIS_VERSION}" ;;
        --help|-h|help)
            cat <<'USAGE'

Aegis-VPN v3.0.0

Usage:
  aegis-vpn                          Interactive menu
  aegis-vpn setup                    Verify dependencies and prepare directories
  aegis-vpn add                      Add a new VPN client
  aegis-vpn remove                   Remove an existing client
  aegis-vpn list                     List all clients with live status
  aegis-vpn status                   Show service status and per-peer bandwidth
  aegis-vpn rotate [<client>]        Rotate keys for a client (keeps IP/DNS)
  aegis-vpn rotate-server [--qr]    Rotate the SERVER private key; updates all client configs
                                     --qr also re-displays QR codes for every client
  aegis-vpn backup                   Create tarball backup of all configs
  aegis-vpn restore <file>           Restore from a backup tarball
  aegis-vpn check                    Validate wg0.conf integrity
  aegis-vpn dashboard [--privacy]    Live peer dashboard (refreshes every 5s)
  aegis-vpn logs [--errors|--audit] [--privacy]
                                     Stream logs (--privacy masks IPs)
  aegis-vpn version                  Print version string
  aegis-vpn --help                   Show this help

USAGE
            ;;
        *)
            print_err "Unknown command: $1"
            echo "  Run 'aegis-vpn --help' for usage."
            exit 1
            ;;
    esac
}

main "$@"
